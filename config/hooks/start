#!/bin/sh

# This hook script is to be executed by a git "update" hook used for deployment:
# https://raw.githubusercontent.com/bnf/giddyup/master/update-hook
#
# It is executed after the deployed version is activated (symlinked from "current")
# That means this script may operate on the live database.

# In theory opcache clearing shouldn't be required as we're
# using a static docroot in vendor/autoload.php,
# but opcache seems to cache the entrypoint (e.g. web/index.php).
# https://github.com/zendtech/ZendOptimizerPlus/issues/126#issuecomment-221038140
local FCGI_SOCKET="$(get_config fcgi-socket)"
FCGI_SOCKET="${FCGI_SOCKET:-/run/php/php7.0-fpm.sock}"
test -w "${FCGI_SOCKET}" && ${RELEASE}/vendor/bin/cachetool opcache:reset --fcgi "${FCGI_SOCKET}" || true

${RELEASE}/vendor/bin/typo3cms cache:flush
